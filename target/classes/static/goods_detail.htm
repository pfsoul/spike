<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>商品详情</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!-- jquery -->
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <!-- bootstrap -->
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css" />
    <script type="text/javascript" src="/bootstrap/js/bootstrap.min.js"></script>
    <!-- jquery-validator -->
    <script type="text/javascript" src="/jquery-validation/jquery.validate.min.js"></script>
    <script type="text/javascript" src="/jquery-validation/localization/messages_zh.min.js"></script>
    <!-- layer -->
    <script type="text/javascript" src="/layer/layer.js"></script>
    <!-- md5.js -->
    <script type="text/javascript" src="/js/md5.min.js"></script>
    <!-- common.js -->
    <script type="text/javascript" src="/js/common.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>登录</title>
    <!-- jquery -->
    <script type="text/javascript" th:src="@{/js/jquery.min.js}"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="/eshop/css/bootstrap.min.css" rel="stylesheet">
    <link href="/eshop/css/font-awesome.min.css" rel="stylesheet">
    <link href="/eshop/css/prettyPhoto.css" rel="stylesheet">
    <link href="/eshop/css/price-range.css" rel="stylesheet">
    <link href="/eshop/css/animate.css" rel="stylesheet">
    <link href="/eshop/css/main.css" rel="stylesheet">
    <link href="/eshop/css/responsive.css" rel="stylesheet">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="/eshop/js/html5shiv.js"></script>
    <script type="text/javascript" src="/eshop/js/respond.min.js"></script>
    <![endif]-->
    <link rel="shortcut icon" th:href="/eshop/images/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/eshop/images/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/eshop/images/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/eshop/images/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/eshop/images/ico/apple-touch-icon-57-precomposed.png">

</head>
<body>
<header id="header"><!--header-->
    <div class="header_top"><!--header_top-->
        <div class="container">
            <div class="row">
                <div class="col-sm-6">
                    <div class="contactinfo">
                        <ul class="nav nav-pills">
                            <li><a href=""><i class="fa fa-phone"></i> +86 123 4567 8910</a></li>
                            <li><a href=""><i class="fa fa-envelope"></i> work@hotmail.com</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="social-icons pull-right">
                        <ul class="nav navbar-nav">
                            <li><a href=""><i class="fa fa-facebook"></i></a></li>
                            <li><a href=""><i class="fa fa-twitter"></i></a></li>
                            <li><a href=""><i class="fa fa-linkedin"></i></a></li>
                            <li><a href=""><i class="fa fa-dribbble"></i></a></li>
                            <li><a href=""><i class="fa fa-google-plus"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div><!--/header_top-->

    <div class="header-middle"><!--header-middle-->
        <div class="container">
            <div class="row">
                <div class="col-sm-4">
                    <div class="logo pull-left">
                        <a href="/index.html"><span>E</span>-Shop</a>
                    </div>
                    <div class="btn-group pull-right">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle usa" data-toggle="dropdown">
                                CHINA
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="">Canada</a></li>
                                <li><a href="">UK</a></li>
                            </ul>
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle usa" data-toggle="dropdown">
                                ￥
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="">Canadian Dollar</a></li>
                                <li><a href="">Pound</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-sm-8">
                    <div class="shop-menu pull-right">
                        <ul class="nav navbar-nav">
                            <li><a href=""><i class="fa fa-user"></i> Account</a></li>
                            <li><a href=""><i class="fa fa-star"></i> Wishlist</a></li>
                            <li><a href="checkout.html"><i class="fa fa-crosshairs"></i> Checkout</a></li>
                            <li><a href="cart.html"><i class="fa fa-shopping-cart"></i> Cart</a></li>
                            <li><a href="login/to_login" class="active" id="nickname"><i class="fa fa-lock"></i> Login</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div><!--/header-middle-->

    <div class="header-bottom"><!--header-bottom-->
        <div class="container">
            <div class="row">
                <div class="col-sm-9">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                    </div>
                    <div class="mainmenu pull-left">
                        <ul class="nav navbar-nav collapse navbar-collapse">
                            <li><a href="/index">Home</a></li>
                            <li class="dropdown"><a href="#">Shop<i class="fa fa-angle-down"></i></a>
                                <ul role="menu" class="sub-menu">
                                    <li><a href="/goods/to_list">秒杀商品</a></li>
                                    <li><a href="product-details.html">Product Details</a></li>
                                    <li><a href="checkout.html">Checkout</a></li>
                                    <li><a href="cart.html">Cart</a></li>
                                </ul>
                            </li>
                            <li class="dropdown"><a href="#">Blog<i class="fa fa-angle-down"></i></a>
                                <ul role="menu" class="sub-menu">
                                    <li><a href="blog.html">Blog List</a></li>
                                    <li><a href="blog-single.html">Blog Single</a></li>
                                </ul>
                            </li>
                            <li><a href="404.html">404</a></li>
                            <li><a href="contact-us.html">Contact</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="search_box pull-right">
                        <input type="text" placeholder="Search"/>
                    </div>
                </div>
            </div>
        </div>
    </div><!--/header-bottom-->
</header><!--/header-->
<div class="panel panel-default">
  <div class="panel-heading">秒杀商品详情</div>
  <div class="panel-body">
  	<span id="userTip"> 您还没有登录，请登陆后再操作<br/></span>
  	<span>没有收货地址的提示</span>
  </div>
  <table class="table" id="goodslist">
  	<tr>  
        <td>商品名称</td>  
        <td colspan="3" id="goodsName"></td>
     </tr>  
     <tr>  
        <td>商品图片</td>  
        <td colspan="3"><img id="goodsImg" wid="200" height="200" /></td>
     </tr>
     <tr>  
        <td>秒杀开始时间</td>  
        <td id="startTime"></td>
        <td >
        	<input type="hidden" id="remainSeconds" />
        	<span id="spikeTip"></span>
        </td>
        <td>
        	<!--<form id="miaoshaForm" method="post" action="/spike/do_spike">-->
        		<!--<button class="btn btn-primary btn-block" type="submit" id="buyButton" onclick="doSpike()">立即秒杀</button>-->
        		<!--<input type="hidden" name="goodsId" id="goodsId" />-->
        	<!--</form>-->
            <div class="row">
                <div class="form-inline">
                    <img id="verifyCodeImg" width="80px" height="32px" style="display: none" onclick="refreshVerifyCodeImg()"/>
                    <input id="verifyCode" class="form-control" style="display: none">
                    <button class="btn btn-primary" type="button" id="buyButton" onclick="getSpikePath()">立即秒杀</button>
                </div>
            </div>
            <input type="hidden" name="goodsId" id="goodsId" />
        </td>
     </tr>
     <tr>  
        <td>商品原价</td>  
        <td colspan="3" id="goodsPrice"></td>
     </tr>
      <tr>  
        <td>秒杀价</td>  
        <td colspan="3" id="spikePrice"></td>
     </tr>
     <tr>  
        <td>库存数量</td>  
        <td colspan="3" id="stockCount"></td>
     </tr>
  </table>
</div>
<footer id="footer"><!--Footer-->
    <div class="footer-top">
        <div class="container">
            <div class="row">
                <div class="col-sm-2">
                    <div class="companyinfo">
                        <h2><span>e</span>-shop</h2>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit,sed do eiusmod tempor</p>
                    </div>
                </div>
                <div class="col-sm-7">
                    <div class="col-sm-3">
                        <div class="video-gallery text-center">
                            <a href="#">
                                <div class="iframe-img">
                                    <img src="/eshop/images/home/iframe1.png" alt="" />
                                </div>
                                <div class="overlay-icon">
                                    <i class="fa fa-play-circle-o"></i>
                                </div>
                            </a>
                            <p>Circle of Hands</p>
                            <h2>24 DEC 2014</h2>
                        </div>
                    </div>

                    <div class="col-sm-3">
                        <div class="video-gallery text-center">
                            <a href="#">
                                <div class="iframe-img">
                                    <img src="/eshop/images/home/iframe2.png" alt="" />
                                </div>
                                <div class="overlay-icon">
                                    <i class="fa fa-play-circle-o"></i>
                                </div>
                            </a>
                            <p>Circle of Hands</p>
                            <h2>24 DEC 2014</h2>
                        </div>
                    </div>

                    <div class="col-sm-3">
                        <div class="video-gallery text-center">
                            <a href="#">
                                <div class="iframe-img">
                                    <img src="/eshop/images/home/iframe3.png" alt="" />
                                </div>
                                <div class="overlay-icon">
                                    <i class="fa fa-play-circle-o"></i>
                                </div>
                            </a>
                            <p>Circle of Hands</p>
                            <h2>24 DEC 2014</h2>
                        </div>
                    </div>

                    <div class="col-sm-3">
                        <div class="video-gallery text-center">
                            <a href="#">
                                <div class="iframe-img">
                                    <img src="/eshop/images/home/iframe4.png" alt="" />
                                </div>
                                <div class="overlay-icon">
                                    <i class="fa fa-play-circle-o"></i>
                                </div>
                            </a>
                            <p>Circle of Hands</p>
                            <h2>24 DEC 2014</h2>
                        </div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="address">
                        <img src="/eshop/images/home/map.png" alt="" />
                        <p>505 S Atlantic Ave Virginia Beach, VA(Virginia)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <div class="container">
            <div class="row">
                <p class="pull-left">Copyright © 2013 E-Shop Inc. All rights reserved.</p>
                <p class="pull-right">Designed by <span><a target="_blank" href="http://invoinn.com/">InvoInn</a></span></p>
            </div>
        </div>
    </div>

</footer><!--/Footer-->
</body>
<script>
$(function() {
    //countDown();
    getDetail();
});
function getSpikeResult(goodsId) {
    g_showLoading();
    $.ajax({
        url:"/spike/result",
        type:"GET",
        data:{
            goodsId:$("#goodsId").val()
        },
        success:function (data) {
            if (data.code == 1){
                var result = data.data;
                if (result < 0) {
                    layer.msg("对不起，秒杀失败")
                }else if (result == 0) { //继续轮询，50ms等待
                    setTimeout(function () {
                        getSpikeResult(goodsId);
                    }, 200);
                } else {
                    layer.confirm("秒杀成功，查看订单？",{btn:["确定","取消"]},
                        function () {
                            window.location.href = "/order_detail.htm?orderId="+result;
                        },function () {
                            layer.closeAll();
                        })
                }
            } else{
                layer.msg(data.msg);
            }
        },error:function () {
            layer.msg("客户端请求有误");
        }
    })
}

function doSpike(path) {
    $.ajax({
        url:"/spike/"+path+"/do_spike",
        type:"POST",
        data:{
            goodsId:$("#goodsId").val()
        },
        success:function (data) {
            if (data.code == 1){
                getSpikeResult(goodsId);
                // window.location.href = "/order_detail.htm?orderId="+data.data.id;
            } else{
                layer.msg(data.msg);
            }
        },error:function () {
            layer.msg("客户端请求有误");
        }
    })
}

function getSpikePath() {
    g_showLoading();
    var verifyCode = $("#verifyCode").val();
    if ( verifyCode == "") {
        layer.msg("请输入验证码");
        return;
    }
    $.ajax({
        url:"/spike/path",
        type:"GET",
        data:{
            goodsId:$("#goodsId").val(),
            verifyCode:$("#verifyCode").val()
        },
        success:function (data) {
            if (data.code == 1){
                var path = data.data;
                doSpike(path);
            } else{
                //验证失败则刷新验证码
                $("#verifyCodeImg").attr("src", "/spike/verifyCode?goodsId=" + $("#goodsId").val() + "&timestamp=" + new Date().getTime());
                layer.msg(data.msg);
            }
        },error:function () {
            layer.msg("客户端请求有误");
        }
    });
}

function getDetail() {
    var goodsId = g_getQueryString("goodsId");
    $.ajax({
        url:"/goods/detail/" + goodsId,
        type:"GET",
        success:function (data) {
            if (data.code == 1) {
                render(data.data);
            } else {
                layer.msg(data.msg);
            }
        },error:function () {
            layer.msg("客户端请求有误");
        }
    });
}

function render(detail) {
    var spikeStatus = detail.spikeStatus;

    var remainSeconds = detail.remainSeconds;

    var goods = detail.goods;

    var user = detail.user;

    if (user) {
        $("#userTip").hide();
        $("#nickname").text(user.nickname);
    }

    $("#goodsName").text(goods.goodsName);
    $("#goodsImg").attr("src", goods.goodsImg);
    $("#startTime").text(new Date(goods.startDate).format("yyyy-MM-dd hh:mm:ss"));
    $("#remainSeconds").val(remainSeconds);
    $("#goodsId").val(goods.id);
    $("#goodsPrice").text(goods.goodsPrice);
    $("#spikePrice").text(goods.spikePrice);
    $("#stockCount").text(goods.stockCount);
    countDown();
}

function countDown(){
	var remainSeconds = $("#remainSeconds").val();
	var timeout;
	if(remainSeconds > 0){//秒杀还没开始，倒计时
		$("#buyButton").attr("disabled", true);
        $("#spikeTip").html("秒杀倒计时："+remainSeconds+"秒");
		timeout = setTimeout(function() {
            $("#countDown").text(remainSeconds - 1);
            $("#remainSeconds").val(remainSeconds - 1);
            countDown();
        },1000);
    }
	else if(remainSeconds == 0) {//秒杀进行中
        $("#buyButton").attr("disabled", false);
        if (timeout) {
            clearTimeout(timeout);
        }
        $("#miaoshaTip").html("秒杀进行中");
        $("#verifyCodeImg").attr("src", "/spike/verifyCode?goodsId=" + $("#goodsId").val());
        $("#verifyCodeImg").show();
        $("#verifyCode").show();
	}
    else
        {//秒杀已经结束
            $("#buyButton").attr("disabled", true);
            $("#miaoshaTip").html("秒杀已经结束");
            $("#verifyCodeImg").hide();
            $("#verifyCode").hide();
        }
}

// 防止浏览器缓存加入时间戳
function refreshVerifyCodeImg() {
    $("#verifyCodeImg").attr("src", "/spike/verifyCode?goodsId=" + $("#goodsId").val() + "&timestamp=" + new Date().getTime());
}


</script>
</html>
